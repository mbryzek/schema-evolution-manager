#!/usr/bin/env ruby
# == Adds a database upgrade script to this repository.
#
# == Usage
#  sem-add <path>
#
# == Example
#  sem-add ./new-script.sql
#

load File.join(File.dirname(__FILE__), 'sem-config')

file = ARGV.shift
if file.to_s.strip == ""
  puts "**** ERROR: Need file path"
  RdocUsage.printAndExit(1)
end

Preconditions.check_state(File.exists?(file), "File[#{file}] could not be found")
Preconditions.check_state(file.match(/\.sql/i), "File[#{file}] must end with .sql")

scripts_dir = File.join(`pwd`.strip, "scripts")
Library.ensure_dir!(scripts_dir)

contents = IO.read(file).strip
now = Time.now.strftime('%Y%m%d-%H%M%S')
target = File.join(scripts_dir, "#{now}.sql")

puts "Adding #{target}"
File.open(target, 'w') do |out|
  out << "-- Author: #{Library.git_user}\n"
  out << "-- Date: #{now}\n\n"
  out << contents
end

Library.system_or_error("git add #{target}")
Library.system_or_error("rm #{file}")

puts "File staged in git. You need to commit and push"
